<!doctype html><html lang="pt-BR"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>NFC Access</title><style>*{box-sizing:border-box;margin:0;padding:0;font-family:"Inter",system-ui,Arial,sans-serif}html,body{height:100%}body{background:radial-gradient(circle at 20% 20%,#0f172a,#020617);color:#fff;overflow:hidden;display:flex;align-items:center;justify-content:center;text-align:center;position:relative;-webkit-user-select:none;-ms-user-select:none;user-select:none;-webkit-touch-callout:none} .bg{position:fixed;inset:0;background:linear-gradient(-45deg,#0ea5e9,#6366f1,#22d3ee,#3b82f6);background-size:400% 400%;animation:floatBg 12s ease infinite;opacity:.08;z-index:-1}@keyframes floatBg{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}h1{font-size:1.8rem;margin-bottom:.5rem;letter-spacing:.05em}p{color:#9ca3af;font-size:.95rem;margin-bottom:1.8rem}button{background:linear-gradient(90deg,#06b6d4,#3b82f6);color:#fff;border:none;border-radius:1.5rem;padding:1.1rem 2.2rem;font-size:1rem;font-weight:700;cursor:pointer;transition:transform .12s,box-shadow .12s;box-shadow:0 6px 25px rgba(59,130,246,.28);touch-action:manipulation;pointer-events:auto}button:active{transform:scale(.96)}#modeBtn{margin-top:1rem;background:linear-gradient(90deg,#22c55e,#15803d);position:relative;z-index:9999;pointer-events:auto}#modeIndicator{display:inline-block;margin-left:.6rem;font-weight:800}#msg{margin-top:2rem;min-height:2.2rem;font-size:1.15rem;font-weight:600;opacity:0;transition:opacity .28s,transform .28s}#msg.show{opacity:1;transform:scale(1.03)}.ok{color:#22c55e}.err{color:#ef4444}.splash{position:fixed;inset:0;background:linear-gradient(180deg,#1e3a8a,#1e40af,#0f172a);display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;z-index:20;animation:fadeIn .6s ease}.splash h1{font-size:2rem;margin-bottom:1rem}.splash button{margin-top:2rem;padding:1.1rem 2.4rem;border-radius:2rem;background:linear-gradient(90deg,#06b6d4,#3b82f6);animation:pulseBtn 2s infinite alternate}@keyframes pulseBtn{to{transform:scale(1.04);box-shadow:0 0 20px rgba(59,130,246,.36)}}@keyframes fadeIn{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}@keyframes fadeOut{to{opacity:0;transform:scale(1.02)}}.wave{width:70px;height:70px;border:4px solid rgba(255,255,255,.18);border-top-color:#38bdf8;border-radius:50%;animation:spin 1.4s linear infinite;margin-bottom:1rem}@keyframes spin{to{transform:rotate(360deg)}}.welcome{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(10px);display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;transform:scale(.95);transition:all .45s ease;z-index:30}.welcome.show{opacity:1;transform:scale(1)}.checkmark{width:80px;height:80px;border-radius:50%;border:4px solid #22c55e;position:relative;animation:popIn .45s ease forwards}.checkmark::after{content:"";position:absolute;left:22px;top:35px;width:22px;height:40px;border-right:4px solid #22c55e;border-bottom:4px solid #22c55e;transform:rotate(45deg) scale(0);transform-origin:bottom left;animation:check .45s ease .22s forwards}@keyframes popIn{from{transform:scale(.6);opacity:0}to{transform:scale(1);opacity:1}}@keyframes check{to{transform:rotate(45deg) scale(1)}}audio{display:none}</style><body><div class="bg"></div>

<!-- Splash -->
<div class="splash" id="splash" role="dialog" aria-modal="true">
  <div class="wave" aria-hidden="true"></div>
  <h1>üîê NFC Access</h1>
  <p>Precisamos da sua permiss√£o para acessar o sensor NFC</p>
  <button id="allowBtn" type="button">Permitir Acesso</button>
</div>

<!-- Main -->
<main style="opacity:0;transition:opacity .6s ease;">
  <h1>üîê NFC Access</h1>
  <p id="info">Aproxime seu cart√£o NFC</p>
  <div style="display:flex;gap:.6rem;align-items:center;justify-content:center">
    <button id="modeBtn" type="button" aria-pressed="false">Modo:<span id="modeIndicator">Acesso</span></button>
  </div>
  <div id="msg" role="status" aria-live="polite"></div>
</main>

<!-- Welcome -->
<div class="welcome" id="welcome" aria-hidden="true"><div class="checkmark" aria-hidden="true"></div><h2 id="welcomeText">Bem-vindo!</h2></div>

<!-- Sons -->
<audio id="beep" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>
<audio id="plim" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg" preload="auto"></audio>

<script>
(() => {
  const $ = id => document.getElementById(id);
  const LS = 'nfc_users_v1';
  let mode = 'acesso', reader = null;

  const modeBtn = $('modeBtn');
  const modeIndicator = $('modeIndicator');

  function db(){ try{ return JSON.parse(localStorage.getItem(LS)||'{}') }catch(e){ return {} } }
  function save(d){ localStorage.setItem(LS, JSON.stringify(d)) }
  function showMsg(txt, cls=''){ const el = $('msg'); el.className = cls ? ('show '+cls) : 'show'; el.textContent = txt }
  function playSound(id){ const a = $(id); if(a){ a.currentTime = 0; a.play().catch(()=>{}) } }
  function showWelcome(txt){ $('welcomeText').textContent = txt; const w = $('welcome'); w.classList.add('show'); setTimeout(()=>w.classList.remove('show'), 2200) }

  // Toggle logic (robust): use pointerdown to prevent long-press menus, pointerup capture to ensure we catch it early.
  const toggle = (ev) => {
    if (ev && ev.cancelable) { ev.preventDefault(); }
    mode = (mode === 'acesso') ? 'cadastro' : 'acesso';
    modeIndicator.textContent = (mode === 'acesso') ? 'Acesso' : 'Cadastro';
    modeBtn.setAttribute('aria-pressed', mode==='cadastro');
    showMsg('Modo alterado para ' + mode);
  };

  // handle different event types to maximize compatibility
  modeBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); }, {passive:false});
  modeBtn.addEventListener('pointerup', (e)=>{ e.stopPropagation(); toggle(e); }, {passive:false});
  modeBtn.addEventListener('touchstart', (e)=>{ e.preventDefault(); }, {passive:false});
  modeBtn.addEventListener('click', (e)=>{ e.preventDefault(); toggle(e); });

  // Also add a document-level pointerup in capture to ensure we get the touch even if something else intercepts
  document.addEventListener('pointerup', (e) => {
    // if the pointerup happened inside modeBtn element, let modeBtn handle it (we already toggle there)
    if (modeBtn.contains(e.target)) return;
  }, true);

  // Prevent selection/popups from long-press globally
  document.addEventListener('selectionchange', ()=>{ const s=document.getSelection(); if(s && s.toString().length) s.removeAllRanges(); });

  // Splash -> request NFC permission and start continuous scan
  $('allowBtn').addEventListener('click', async () => {
    if (!('NDEFReader' in window)) { alert('Seu navegador n√£o suporta Web NFC. Use Chrome em Android com HTTPS.'); return; }
    try {
      reader = new NDEFReader();
      await reader.scan(); // must be in user gesture
      const s = $('splash'); s.style.animation = 'fadeOut .35s forwards';
      setTimeout(()=>{ s.remove(); document.querySelector('main').style.opacity = 1; }, 380);
      $('info').textContent = 'Lendo NFC continuamente...';

      reader.addEventListener('readingerror', ()=>console.warn('Erro de leitura NFC'));
      reader.addEventListener('reading', async evt => {
        const id = evt.serialNumber || ('id-'+Math.random().toString(36).slice(2,10));
        const users = db();
        if (mode === 'cadastro') {
          const nome = prompt('Nome para cadastrar?');
          if (!nome) { showMsg('Cadastro cancelado','err'); return; }
          users[id] = nome; save(users);
          showMsg('‚úÖ '+nome+' cadastrado!','ok'); playSound('plim'); showWelcome('Cadastrado!');
        } else {
          if (users[id]) {
            showMsg('‚úÖ Bem-vindo, '+users[id]+'!','ok'); playSound('plim'); playSound('beep'); showWelcome('Bem-vindo '+users[id]+'!');
          } else {
            showMsg('‚õî Cart√£o n√£o registrado','err'); playSound('beep'); showWelcome('Acesso Negado');
          }
        }
      });
    } catch (err) {
      console.error(err);
      alert('Permiss√£o negada ou erro ao acessar o NFC.');
    }
  });

  // keyboard accessibility
  modeBtn.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggle(e); } });

})();
</script></body></html>
