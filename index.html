<!doctype html><html lang="pt-BR"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>NFC Access</title><style>/* compact, mobile-first */*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}html,body{height:100%}body{margin:0;font-family:system-ui,Arial;background:radial-gradient(circle at top,#071026,#020617);color:#e6eef6;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;text-align:center;user-select:none;-webkit-user-select:none}h1{font-size:18px;margin:0 0 8px}p{margin:0 0 14px;color:#94a3b8;font-size:13px}button{appearance:none;border:0;padding:12px 18px;border-radius:12px;font-weight:700;background:linear-gradient(90deg,#22d3ee,#3b82f6);color:#021226;box-shadow:0 8px 30px rgba(59,130,246,.12);cursor:pointer;touch-action:manipulation}button:active{transform:translateY(1px)}#modeBtn{background:linear-gradient(90deg,#34d399,#10b981);margin-top:12px}#msg{margin-top:14px;min-height:36px;font-weight:700}small{display:block;color:#94a3b8;margin-top:8px;font-size:12px}kbd{background:rgba(255,255,255,.03);padding:6px 8px;border-radius:8px;font-weight:800;color:#dbeafe}#floating{position:fixed;top:18px;right:18px;z-index:9999}#floating button{padding:10px 12px;border-radius:10px;font-size:13px}@media(min-width:520px){body{padding:40px}} </style><body>
<h1>üîê NFC Access</h1>
<p id="info">Abra a p√°gina e pressione <kbd>Iniciar Leitura</kbd> (necess√°rio para permitir NFC)</p>
<button id="startBtn">Iniciar Leitura</button>
<button id="modeBtn">Modo: Acesso</button>
<div id="msg"></div>
<small>Funciona em Chrome Android (HTTPS ou localhost)</small>

<script>
(() => {
  const $ = id => document.getElementById(id);
  const LS = 'nfc_users_v1';
  let reader = null;
  let scanning = false;
  let mode = 'acesso'; // 'acesso' | 'cadastro'

  function db(){ try{return JSON.parse(localStorage.getItem(LS)||'{}')}catch(e){return{}}}
  function save(d){ localStorage.setItem(LS, JSON.stringify(d)) }
  function show(txt, cls=''){ const m = $('msg'); m.textContent = txt; m.className = cls || ''; }
  function setModeUI(){ $('modeBtn').textContent = 'Modo: ' + (mode==='acesso' ? 'Acesso' : 'Cadastro'); }

  // toggles mode; bind to multiple events to be robust on mobile
  function toggleMode(e){
    if(e && e.preventDefault) e.preventDefault();
    mode = (mode === 'acesso') ? 'cadastro' : 'acesso';
    setModeUI();
    show('Modo alterado para '+mode);
  }
  $('modeBtn').addEventListener('click', toggleMode, {passive:true});
  $('modeBtn').addEventListener('touchstart', (e)=>{ e.preventDefault(); toggleMode(e); }, {passive:false});

  // start/stop scanning (start must be inside user gesture)
  async function startScan(){
    if(!('NDEFReader' in window)){ show('NFC n√£o suportado neste navegador','err'); return; }
    try{
      reader = new NDEFReader();
      await reader.scan(); // permission prompt happens here
      scanning = true;
      $('startBtn').textContent = 'Parar Leitura';
      show('Aproxime um cart√£o ‚Äî leitura cont√≠nua');
      $('info').textContent = 'Leitura ativa ‚Äî aproxime o cart√£o';
      // keep onreading handler lightweight to avoid blocking UI
      reader.onreadingerror = ()=>console.warn('NFC reading error');
      reader.onreading = async (evt) => {
        // get stable id (serialNumber preferred)
        const id = evt.serialNumber || ('id-'+Math.random().toString(36).slice(2,10));
        const users = db();
        if(mode==='cadastro'){
          // small synchronous prompt is acceptable here (user intent)
          const nome = prompt('Nome para cadastrar?');
          if(!nome){ show('Cadastro cancelado','err'); return; }
          users[id] = nome;
          save(users);
          show('‚úÖ '+nome+' cadastrado!');
          // keep scanning (do not null reader.onreading)
        } else {
          if(users[id]){
            show('‚úÖ Bem-vindo, '+users[id]+'!');
          } else {
            show('‚õî Cart√£o n√£o registrado','err');
          }
        }
      };
    }catch(err){
      console.error(err);
      show('Permiss√£o negada ou erro NFC','err');
      // ensure ui state consistent
      scanning = false;
      $('startBtn').textContent = 'Iniciar Leitura';
      $('info').textContent = 'Aproxime seu cart√£o NFC';
    }
  }

  function stopScan(){
    try{
      // NDEFReader has no stop method, but clearing handlers and dropping reference is best effort
      if(reader){
        reader.onreading = null;
        reader.onreadingerror = null;
        reader = null;
      }
    }catch(e){console.warn(e)}
    scanning = false;
    $('startBtn').textContent = 'Iniciar Leitura';
    $('info').textContent = 'Leitura pausada';
    show('Leitura parada');
  }

  $('startBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    // if scanning, stop; else start (this click is the required user gesture)
    if(scanning){ stopScan(); return; }
    // slight delay to allow UI update before permission prompt
    await startScan();
  }, {passive:false});

  // initialize UI
  setModeUI();
  show('Pronto');
})();
</script>
</body></html>
